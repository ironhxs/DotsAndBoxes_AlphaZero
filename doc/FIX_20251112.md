# 修复说明 - 2025-11-12

## 问题 1: 混合精度训练类型不匹配

### 错误信息
```
RuntimeError: Input type (c10::Half) and bias type (float) should be the same
```

### 原因
- 第一轮训练后，模型被移到 CPU (`self.nnet.cpu()`)
- 第二轮训练时，模型需要重新移到 GPU
- AMP (Automatic Mixed Precision) 会将输入自动转为 Half 类型
- 但如果模型权重还是 float 类型，就会类型不匹配

### 解决方案
在 `base_coach.py` 的 `train()` 方法开始时，确保模型在正确的设备上：

```python
# 确保模型在正确的设备上
if self.args.get('cuda', False):
    self.nnet.cuda()

self.nnet.train()
```

这样每次训练前都会将模型从 CPU 移回 GPU，确保与 AMP 兼容。

## 问题 2: 进度条格式优化

### 需求
- 将 epoch 数 `[145/300]` 放到百分比后面的原位置
- 将 "训练" 改为英文 "Train"
- Loss 显示在时间后面

### 最终格式
```
Train: 48%|████████| 145/300 [01:41<01:46, Loss=4.5568]
```

### 实现
```python
progress_bar = tqdm(
    total=total_epochs,
    desc='  Train',
    bar_format='{desc}: {percentage:3.0f}%|{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}, {postfix}]'
)

# 更新时
progress_bar.update(1)
progress_bar.set_postfix_str(f'Loss={avg_total_loss:.4f}')
```

### 说明
- `{n_fmt}/{total_fmt}`: 显示 145/300
- `{postfix}`: 显示 Loss=4.5568
- 没有 `{rate_fmt}` 所以不显示迭代速度

## 修改的文件

- `model/base_coach.py`:
  - 在 `train()` 方法开始添加 `self.nnet.cuda()`
  - 修改进度条格式为 `Train: {percentage}%|{bar}| {n}/{total} [{time}, {postfix}]`
  - 使用 `set_postfix_str(f'Loss={loss:.4f}')` 更新 Loss

## 测试

运行测试脚本验证：
```bash
python tests/test_final_format.py
```

预期输出：
```
Train: 48%|████████| 145/300 [01:41<01:46, Loss=4.5568]
```
