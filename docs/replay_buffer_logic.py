#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç»éªŒæ± å¤§å°æ§åˆ¶é€»è¾‘è¯¦è§£
æ¸…æ™°å±•ç¤ºå¦‚ä½•é€šè¿‡é…ç½®æ§åˆ¶ç»éªŒæ± 
"""


def explain_replay_buffer_logic():
    """è¯¦ç»†è§£é‡Šç»éªŒæ± æ§åˆ¶é€»è¾‘"""
    
    print("="*80)
    print("ç»éªŒæ± å¤§å°æ§åˆ¶é€»è¾‘è¯¦è§£")
    print("="*80)
    
    print("\n" + "ğŸ“‹ é…ç½®å‚æ•° (config.yaml)".center(80, "="))
    print("""
    num_self_play_games: 300     # æ¯æ¬¡è¿­ä»£çš„æ¸¸æˆå±€æ•°
    replay_buffer_size: 36000    # æœŸæœ›çš„æ ·æœ¬æ€»æ•°ä¸Šé™
    """)
    
    print("\n" + "âš™ï¸  è®¡ç®—è¿‡ç¨‹ (base_coach.py)".center(80, "="))
    print("""
    æ­¥éª¤ 1: ä¼°ç®—æ¯æ¬¡è¿­ä»£çš„æ ·æœ¬æ•°
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    samples_per_iter = num_self_play_games Ã— 60
                     = 300 Ã— 60
                     = 18,000 æ ·æœ¬/è¿­ä»£
    
    ä¸ºä»€ä¹ˆæ˜¯ 60?
    â†’ å‡è®¾æ¯å±€æ¸¸æˆå¹³å‡èµ° 60 æ­¥
    â†’ æ¯æ­¥äº§ç”Ÿä¸€ä¸ªè®­ç»ƒæ ·æœ¬ (state, policy, value)
    
    æ­¥éª¤ 2: è®¡ç®—åº”è¯¥ä¿ç•™å¤šå°‘æ¬¡è¿­ä»£
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    max_iters = replay_buffer_size Ã· samples_per_iter
              = 36,000 Ã· 18,000
              = 2 æ¬¡è¿­ä»£
    
    æ­¥éª¤ 3: åˆ›å»ºå›ºå®šå¤§å°çš„é˜Ÿåˆ—
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    self.train_examples_history = deque(maxlen=2)
    
    âš ï¸ é‡ç‚¹: maxlen=2 è¡¨ç¤ºæœ€å¤šä¿ç•™ 2 ä¸ªå…ƒç´  (2 æ¬¡è¿­ä»£)
            ä¸æ˜¯ 2 ä¸ªæ ·æœ¬!
    """)
    
    print("\n" + "ğŸ’¾ æ•°æ®ç»“æ„".center(80, "="))
    print("""
    train_examples_history çš„ç»“æ„:
    
    deque([
        [iter1çš„18000ä¸ªæ ·æœ¬],  â† å…ƒç´ 1 (ç¬¬1æ¬¡è¿­ä»£)
        [iter2çš„18000ä¸ªæ ·æœ¬],  â† å…ƒç´ 2 (ç¬¬2æ¬¡è¿­ä»£)
    ], maxlen=2)
    
    ä¸æ˜¯:
    deque([æ ·æœ¬1, æ ·æœ¬2, ..., æ ·æœ¬36000], maxlen=36000)  âŒ
    """)
    
    print("\n" + "ğŸ”„ è¿è¡Œæ—¶è¡Œä¸º".center(80, "="))
    print("""
    è¿­ä»£ 1:
      history.append([18000ä¸ªæ ·æœ¬])
      â†’ history = [[iter1çš„18000ä¸ªæ ·æœ¬]]
      â†’ æ€»æ ·æœ¬æ•° = 18,000
    
    è¿­ä»£ 2:
      history.append([18000ä¸ªæ ·æœ¬])
      â†’ history = [[iter1çš„18000ä¸ªæ ·æœ¬], [iter2çš„18000ä¸ªæ ·æœ¬]]
      â†’ æ€»æ ·æœ¬æ•° = 36,000  âœ… è¾¾åˆ°ä¸Šé™
    
    è¿­ä»£ 3:
      history.append([18000ä¸ªæ ·æœ¬])
      â†’ history = [[iter2çš„18000ä¸ªæ ·æœ¬], [iter3çš„18000ä¸ªæ ·æœ¬]]  (è‡ªåŠ¨åˆ é™¤iter1)
      â†’ æ€»æ ·æœ¬æ•° = 36,000  (ä¿æŒç¨³å®š)
    
    è¿­ä»£ 4+:
      åŒæ ·ä¿æŒ 36,000 æ ·æœ¬ (æœ€è¿‘2æ¬¡è¿­ä»£)
    """)
    
    print("\n" + "ğŸ¯ å¦‚ä½•è®¾ç½®ç»éªŒæ± å¤§å°".center(80, "="))
    print("""
    æ–¹æ³•: é€šè¿‡ replay_buffer_size æ§åˆ¶
    
    æƒ³è¦ä¿ç•™ N æ¬¡è¿­ä»£?
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    replay_buffer_size = N Ã— num_self_play_games Ã— 60
    
    ç¤ºä¾‹:
    """)
    
    configs = [
        ("ä¿ç•™ 1 æ¬¡è¿­ä»£", 1, 300, "ä¸æ¨è,æ— å†å²"),
        ("ä¿ç•™ 2 æ¬¡è¿­ä»£", 2, 300, "æå°,ä»…æµ‹è¯•ç”¨"),
        ("ä¿ç•™ 5 æ¬¡è¿­ä»£", 5, 300, "åå°"),
        ("ä¿ç•™ 10 æ¬¡è¿­ä»£", 10, 300, "å¯ç”¨"),
        ("ä¿ç•™ 20 æ¬¡è¿­ä»£", 20, 300, "æ¨è âœ…"),
        ("ä¿ç•™ 50 æ¬¡è¿­ä»£", 50, 300, "å¤§å‹"),
    ]
    
    print(f"  {'ç›®æ ‡':<20} {'é…ç½®å€¼':<15} {'å®é™…æ•ˆæœ':<20} {'è¯„ä»·'}")
    print("  " + "-"*75)
    
    for goal, iters, games, comment in configs:
        buffer_size = iters * games * 60
        samples = iters * games * 60
        print(f"  {goal:<20} {buffer_size:>14,} {f'{iters}æ¬¡è¿­ä»£, {samples:,}æ ·æœ¬':<20} {comment}")


def show_calculation_examples():
    """å±•ç¤ºä¸åŒé…ç½®çš„è®¡ç®—ç¤ºä¾‹"""
    
    print("\n" + "="*80)
    print("é…ç½®è®¡ç®—ç¤ºä¾‹")
    print("="*80)
    
    examples = [
        {
            "name": "å½“å‰æµ‹è¯•é…ç½®",
            "num_games": 300,
            "buffer_size": 36000,
            "expected_iters": 2,
        },
        {
            "name": "æ¨èæ ‡å‡†é…ç½®",
            "num_games": 300,
            "buffer_size": 360000,
            "expected_iters": 20,
        },
        {
            "name": "å°å‹è®­ç»ƒ",
            "num_games": 100,
            "buffer_size": 120000,
            "expected_iters": 20,
        },
        {
            "name": "å¤§å‹è®­ç»ƒ",
            "num_games": 500,
            "buffer_size": 600000,
            "expected_iters": 20,
        },
    ]
    
    for example in examples:
        print(f"\n{'â”€'*80}")
        print(f"ğŸ”¹ {example['name']}")
        print(f"{'â”€'*80}")
        
        games = example['num_games']
        buffer = example['buffer_size']
        
        samples_per_iter = games * 60
        max_iters = max(1, buffer // samples_per_iter)
        actual_samples = max_iters * samples_per_iter
        
        print(f"""
é…ç½®:
  num_self_play_games = {games}
  replay_buffer_size  = {buffer:,}

è®¡ç®—:
  samples_per_iter = {games} Ã— 60 = {samples_per_iter:,}
  max_iters        = {buffer:,} Ã· {samples_per_iter:,} = {max_iters}

ç»“æœ:
  deque(maxlen={max_iters})
  å®é™…æ ·æœ¬ä¸Šé™: {actual_samples:,}
  
{"  âœ… ç¬¦åˆé¢„æœŸ" if max_iters == example['expected_iters'] else f"  âš ï¸  é¢„æœŸ {example['expected_iters']} æ¬¡è¿­ä»£"}
        """)


def show_formula():
    """å±•ç¤ºå…¬å¼æ€»ç»“"""
    
    print("\n" + "="*80)
    print("ğŸ“ å…¬å¼æ€»ç»“")
    print("="*80)
    
    print("""
å…³é”®å…¬å¼:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1ï¸âƒ£ æ¯æ¬¡è¿­ä»£æ ·æœ¬æ•° (ä¼°ç®—):
   samples_per_iter = num_self_play_games Ã— 60

2ï¸âƒ£ ä¿ç•™è¿­ä»£æ¬¡æ•°:
   max_iters = replay_buffer_size Ã· samples_per_iter

3ï¸âƒ£ å®é™…æ ·æœ¬æ€»æ•°:
   actual_total_samples = max_iters Ã— samples_per_iter
   
4ï¸âƒ£ åæ¨é…ç½® (æƒ³ä¿ç•™ N æ¬¡è¿­ä»£):
   replay_buffer_size = N Ã— num_self_play_games Ã— 60

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“Œ é‡è¦æç¤º:

1. deque å­˜å‚¨çš„æ˜¯ "è¿­ä»£" (æ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¬¡è¿­ä»£çš„æ‰€æœ‰æ ·æœ¬)
   ä¸æ˜¯ç›´æ¥å­˜å‚¨æ ·æœ¬!

2. maxlen é™åˆ¶çš„æ˜¯ "è¿­ä»£æ¬¡æ•°"
   ä¸æ˜¯æ ·æœ¬æ€»æ•°!

3. æ ·æœ¬æ€»æ•° = sum(len(iter_samples) for iter_samples in deque)

4. ä¸ºä»€ä¹ˆç”¨ 60?
   â†’ ç»éªŒå€¼: Dots and Boxes å¹³å‡æ¯å±€çº¦ 60 æ­¥
   â†’ å®é™…ä¼šæœ‰æ³¢åŠ¨ (40-80æ­¥)
   â†’ ä½†å¹³å‡ä¸‹æ¥æ¥è¿‘ 60

5. è¾¾åˆ° maxlen åä¼šè‡ªåŠ¨åˆ é™¤æœ€è€çš„è¿­ä»£
   â†’ ä¸ä¼šå´©æºƒ
   â†’ ä¸ä¼šè¶…å‡ºé™åˆ¶
   â†’ å§‹ç»ˆä¿æŒæœ€æ–°çš„ N æ¬¡è¿­ä»£
    """)


if __name__ == '__main__':
    explain_replay_buffer_logic()
    show_calculation_examples()
    show_formula()
